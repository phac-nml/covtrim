image: "continuumio/miniconda3:latest"

before_script:
  - export PATH="$HOME/miniconda3/bin:$PATH"
  - hash -r
  - conda config --add channels bioconda
  - conda config --add channels conda-forge
  - conda config --add channels gosahan
  - conda config --add channels fastchan
  - conda config --set always_yes yes --set changeps1 no
  - conda init bash

stages:
  - 🚧 Setup
  - 📥 Clone
  - 🛠️ Build
  - 📦 Install
  - 🧪 Test
  - 🚀 Publish
  - 💀 CovtrimFinalCheck

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - /opt/conda/conda-bld
    - /opt/conda/pkgs

InstallBaseEnvironment:
  stage: 🚧 Setup
  timeout: 6h
  script:
    - conda create --prefix base-environment -q "python=3.10" -y
    - source /opt/conda/bin/activate base-environment/
  artifacts:
    paths:
      - base-environment
    expire_in: 2 hour


# GitLab CI Stage
GitLabClone:
  stage: 📥 Clone
  timeout: 6h
  script:
    - rm -rf covtrim
    - git clone https://gosahan:$GIT_CLONE_TOKEN@$GIT_URL/gosahan/covtrim.git
  artifacts:
    paths:
      - covtrim
    expire_in: 2 hour

# Build Stage
BuildPackage:
  stage: 🛠️ Build
  needs: [GitLabClone]
  timeout: 6h
  script:
    - conda create --prefix ./conda-build -q -y python=3.10 conda-build conda-verify mamba boa zstandard conda
    - source /opt/conda/bin/activate conda-build/
    - cd covtrim
    - conda build purge
    - conda mambabuild --no-anaconda-upload . || conda build --no-anaconda-upload .
    - PACKAGE_PATH=$(find /opt/conda/conda-bld/linux-64/ -name "covtrim-*.tar.bz2" | head -n 1) || PACKAGE_PATH=$(find /builds/gosahan/covtrim/conda-build/conda-bld/linux-64/ -name "covtrim-*.tar.bz2" | head -n 1)
    - cp $PACKAGE_PATH ../covtrim_package.tar.bz2
  artifacts:
    paths:
      - covtrim_package.tar.bz2
    expire_in: 2 hour


# Install Stage
InstallPackage:
  stage: 📦 Install
  needs: [InstallBaseEnvironment, GitLabClone, BuildPackage]
  timeout: 6h
  script:
    - source /opt/conda/bin/activate base-environment/
    - conda install --use-local covtrim_package.tar.bz2 -q -y
    - conda create --prefix covtrim_env --clone base-environment/ -y
  artifacts:
    paths:
      - covtrim_env
      - covtrim
    expire_in: 2 hour


# Test Stage
HelpMenuTest:
  stage: 🧪 Test
  needs: [InstallPackage]
  timeout: 6h
  script:
    - source /opt/conda/bin/activate covtrim_env/
    - covtrim --help
    - covtrim --version


# Test Stage
CLIModeTest:
  stage: 🧪 Test
  needs: [InstallPackage]
  timeout: 6h
  script:
    - source /opt/conda/bin/activate covtrim_env/
    - cd covtrim
    - covtrim -i example/FAV29196_barcode01_e6e45773_e63dc735_1.fastq -o ./ -tc 10 -s 42


# Publish Stage
PublishPackage:
  stage: 🚀 Publish
  needs: [GitLabClone, BuildPackage, HelpMenuTest, CLIModeTest]
  timeout: 6h
  script:
    - conda create --prefix anaconda-upload -q "python=3.10" anaconda-client -y
    - source /opt/conda/bin/activate anaconda-upload/
    - cd covtrim
    - DESCRIPTION=$(cat README.md)
    - anaconda -t $ANACONDA_TOKEN upload -d "$DESCRIPTION" ../covtrim_package.tar.bz2 --force || anaconda -t $ANACONDA_TOKEN upload -d "$DESCRIPTION" ../covtrim_package.tar.bz2

CovtrimFinalCheck:
  stage: 💀 CovtrimFinalCheck
  needs: [PublishPackage]
  timeout: 6h
  script:
    - conda create --prefix covtrim_env -q -c gosahan covtrim -y
    - source /opt/conda/bin/activate covtrim_env/
    - cd covtrim
    - covtrim -i example/FAV29196_barcode01_e6e45773_e63dc735_1.fastq -o ./ -tc 10 -s 42 || anaconda -t $ANACONDA_TOKEN upload ../covtrim_package.tar.bz2 --force